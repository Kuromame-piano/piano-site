---
import Layout from "../../layouts/Layout.astro";
import { areas } from "../../data/areas";
import { type Area } from "../../data/areas";
import HeroSection from "../../components/area/HeroSection.astro";
import IntroSection from "../../components/area/IntroSection.astro";
import UniqueContentSection from "../../components/area/UniqueContentSection.astro";
import LessonFlowSection from "../../components/area/LessonFlowSection.astro";
import AreaGuideSection from "../../components/area/AreaGuideSection.astro";
import MapSection from "../../components/area/MapSection.astro";
import FAQSection from "../../components/area/FAQSection.astro";
import CTASection from "../../components/area/CTASection.astro";
import RelatedAreasSection from "../../components/area/RelatedAreasSection.astro";
import InstructorSection from "../../components/area/InstructorSection.astro";
import FeeSection from "../../components/area/FeeSection.astro";

export async function getStaticPaths() {
    return areas.map((area) => ({
        params: { slug: area.slug },
        props: { area },
    }));
}

interface Props {
    area: Area;
}

// ... (existing imports)

const { area } = Astro.props;

// 画像の表示位置をエリアごとに調整
const getObjectPosition = (slug: string) => {
    // 下の方（手元など）を映したいエリア
    if (["kiyosumi-shirakawa", "monzen-nakacho"].includes(slug)) {
        return "50% 55%";
    }
    // 引き（全体）を映したいエリア（中央揃えでバランスをとる）
    if (["nihonbashi", "morishita-sumiyoshi"].includes(slug)) {
        return "50% 50%";
    }
    // デフォルト（やや上寄り＝顔重視）
    return "50% 35%";
};
const objectPosition = getObjectPosition(area.slug);

const pageTitle = `${area.subAreas.slice(0, 3).join("・")}のピアノ教室｜出張レッスン専門・髙橋遊月ピアノ教室`;
const pageDescription = `${area.subAreas
    .slice(0, 3)
    .map((s) => s + "のピアノ教室")
    .join(
        "・",
    )}をお探しの方へ。講師がご自宅へ伺う「出張型」のピアノ教室です。${area.lead} 東京音大卒の女性講師によるマンツーマン指導。無料体験レッスン受付中。`;

// Schema.org Structured Data
const schema = JSON.stringify({
    "@context": "https://schema.org",
    "@graph": [
        {
            "@type": "BreadcrumbList",
            itemListElement: [
                {
                    "@type": "ListItem",
                    position: 1,
                    item: {
                        "@id": Astro.site?.toString(),
                        name: "ホーム",
                    },
                },
                {
                    "@type": "ListItem",
                    position: 2,
                    item: {
                        "@id": new URL("/area", Astro.site).toString(),
                        name: "出張エリア",
                    },
                },
                {
                    "@type": "ListItem",
                    position: 3,
                    item: {
                        "@id": Astro.url.toString(),
                        name: area.name,
                    },
                },
            ],
        },
        // LocalBusiness Schema for mobile business
        {
            "@type": ["LocalBusiness", "MusicSchool"],
            "@id": Astro.site?.toString() + "#business",
            name: "髙橋遊月ピアノ教室",
            description: `${area.name}での出張ピアノレッスン。${area.lead}`,
            url: Astro.site?.toString(),
            image: new URL("/senzai.png", Astro.site).toString(),
            telephone: "", // 電話番号があれば追加
            priceRange: "￥5,000～",
            areaServed: [
                {
                    "@type": "City",
                    name: area.name,
                },
                ...area.subAreas.map((sub) => ({
                    "@type": "Place",
                    name: sub,
                })),
            ],
            serviceType: "出張ピアノレッスン",
            hasOfferCatalog: {
                "@type": "OfferCatalog",
                name: "ピアノレッスン",
                itemListElement: [
                    {
                        "@type": "Offer",
                        itemOffered: {
                            "@type": "Service",
                            name: "無料体験レッスン",
                        },
                    },
                ],
            },
        },
        {
            "@type": "Service",
            name: `${area.name}の出張ピアノ教室`,
            provider: {
                "@type": "MusicSchool",
                name: "髙橋遊月ピアノ教室",
                url: Astro.site?.toString(),
                image: new URL("/senzai.png", Astro.site).toString(),
            },
            areaServed: [
                {
                    "@type": "City",
                    name: area.name,
                },
                ...area.subAreas.map((sub) => ({
                    "@type": "Place",
                    name: sub,
                })),
            ],
            description: area.lead,
            url: Astro.url.toString(),
            potentialAction: {
                "@type": "ReserveAction",
                target: {
                    "@type": "EntryPoint",
                    urlTemplate: new URL("/contact", Astro.site).toString(),
                },
                result: {
                    "@type": "Reservation",
                    name: "体験レッスン",
                },
            },
        },
        // FAQPage Schema for rich results (最大3つまで)
        {
            "@type": "FAQPage",
            mainEntity: area.faqs.slice(0, 3).map((faq) => ({
                "@type": "Question",
                name: faq.question,
                acceptedAnswer: {
                    "@type": "Answer",
                    text: faq.answer,
                },
            })),
        },
    ],
});
---

<Layout
    title={pageTitle}
    description={pageDescription}
    image={area.mainImage}
    keywords={area.keywords}
>
    <!-- Structured Data -->
    <script slot="head" type="application/ld+json" set:html={schema} />

    <!-- Preload Critical Image -->
    <link slot="head" rel="preload" as="image" href={area.mainImage} />

    <HeroSection area={area} objectPosition={objectPosition} />

    <IntroSection area={area} />

    <UniqueContentSection area={area} />

    <InstructorSection area={area} />

    <FeeSection area={area} />

    <LessonFlowSection area={area} />

    <FAQSection area={area} />

    <MapSection area={area} />

    <AreaGuideSection area={area} />

    <CTASection area={area} />

    <RelatedAreasSection />
</Layout>
